<?xml version="1.0" encoding="utf-8" ?>
<ContentPage 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:diary="clr-namespace:Daily.Diary"
    xmlns:viewmodels="clr-namespace:Daily.ViewModels"
    xmlns:converters="clr-namespace:Daily.Converters"  
    x:Class="Daily.Pages.DiaryRecordPage"
    x:DataType="viewmodels:DiaryRecordPageViewModel"
    Style="{StaticResource DiaryPage}">

    <ContentPage.Resources>

        <ResourceDictionary>

            <converters:BoolToColorConverter
                x:Key="CanDeleteToColorConverter"
                TrueColor="{StaticResource RedSelected}"
                FalseColor="{StaticResource DiaryHovers}"/>
            
            <Style TargetType="Frame" x:Key="DiaryRecordCard" BasedOn="{StaticResource RecordCard}">
                <Setter Property="VisualStateManager.VisualStateGroups">
                    <VisualStateGroupList>
                        <VisualStateGroup x:Name="CommonStates">
                            <VisualState x:Name="Normal" />
                            <VisualState x:Name="Selected">
                                <VisualState.Setters>
                                    <Setter Property="BackgroundColor" Value="{StaticResource DiaryHovers}"/>
                                </VisualState.Setters>
                            </VisualState>
                        </VisualStateGroup>
                    </VisualStateGroupList>
                </Setter>
            </Style>
            
            <Style TargetType="ImageButton" x:Key="DiaryActionButton" BasedOn="{StaticResource ActionButton}">
                <Setter Property="BackgroundColor" Value="{StaticResource DiaryHovers}"/>
            </Style>

        </ResourceDictionary>
        
    </ContentPage.Resources>

    <Grid
        ColumnDefinitions="*"
        RowDefinitions="Auto, Auto, *"
        VerticalOptions="Fill"
        HorizontalOptions="Fill"
        Padding="{StaticResource RootPadding}">

        <Label
            Style="{StaticResource Headline}"
            Text="Дневник"
            Margin="{StaticResource HeadlineMargin}"
            Grid.Column="0"
            Grid.Row="0"/>

        <VerticalStackLayout
            IsVisible="{Binding IsLoaded, Converter={toolkit:InvertedBoolConverter}}"
            Margin="{StaticResource DummyLabelMargin}"
            Grid.Column="0"
            Grid.Row="1">

            <ActivityIndicator
                Style="{StaticResource DummyActivityIndicator}"
                Color="{StaticResource DiaryInputField}"/>

            <Label
                TextColor="{StaticResource DiaryInputField}"
                Text="Загружаем записи.."
                HorizontalOptions="Center"/>
        </VerticalStackLayout>

        <CollectionView
            Style="{StaticResource RecordCollectionView}"
            IsVisible="{Binding IsLoaded}"
            ItemsSource="{Binding Loader.Result}"
            SelectedItem="{Binding SelectedDiaryRecord, Mode=TwoWay}"
            SelectionChangedCommand="{Binding DiaryRecordInteractCommand}"
            SelectionChangedCommandParameter="{Binding SelectedItem, Source={RelativeSource Mode=Self}}"
            Grid.Column="0"
            Grid.Row="1">

            <CollectionView.EmptyView>
                <Label
                    Style="{StaticResource EmptyViewLabel}"/>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame
                        x:DataType="diary:DiaryRecord"
                        Style="{StaticResource DiaryRecordCard}"
                        BackgroundColor="{StaticResource DiaryHovers}">

                        <VerticalStackLayout
                            Padding="10, 0, 10, 0">

                            <Label
                                Style="{StaticResource RecordHeaderLabel}"
                                Text="{Binding CreationDateTime, StringFormat='{0:d}'}"/>

                            <Label
                                Style="{StaticResource RecordContentLabel}"
                                TextColor="{StaticResource DiaryInputField}"
                                Text="{Binding Text}"/>
                        </VerticalStackLayout>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <Frame
            Style="{StaticResource BottomPanel}"
            BackgroundColor="{StaticResource DiaryBackground}"
            BorderColor="{StaticResource DiaryInputField}"
            Grid.Column="0"
            Grid.Row="2">

            <HorizontalStackLayout
                Spacing="20"
                VerticalOptions="Center"
                HorizontalOptions="Center">

                <VerticalStackLayout>
                    <ImageButton
                        Style="{StaticResource DiaryActionButton}"
                        IsEnabled="{Binding CanInteractWithDiaryRecord}"
                        Padding="5, 5, 5, 5"
                        Source="add.png"
                        Command="{Binding AddDiaryRecordCommand}"/>

                    <Label
                        Style="{StaticResource ActionButtonLabel}"
                        Text="Создать"/>
                </VerticalStackLayout>

                <VerticalStackLayout>
                    <ImageButton
                        Style="{StaticResource DiaryActionButton}"
                        BackgroundColor="{Binding CanDeleteDiaryRecord, Converter={StaticResource CanDeleteToColorConverter}}"
                        IsEnabled="{Binding CanInteractWithDiaryRecord}"
                        Padding="5, 5, 5, 5"
                        Source="delete.png"
                        Command="{Binding SwitchCanDeleteCommand}"/>

                    <Label
                        Style="{StaticResource ActionButtonLabel}"
                        Text="Удалить"/>
                </VerticalStackLayout>
            </HorizontalStackLayout>
        </Frame>
    </Grid>
</ContentPage>